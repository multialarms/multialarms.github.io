<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MULTI ALARM CLOCK SYSTEM + TIME CALCULATOR</title>
	<nav>
    <a href="index.html">Home</a>
    <a href="TimeCalculator.html">Time Calculator</a>
</nav>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{
    font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
    background:linear-gradient(135deg,#1e3c72 0%,#2a5298 100%);
    color:#fff;
    min-height:100vh;
    overflow-x:hidden;
}
#layout { display:flex; height:100vh; }
 
/* ===== CALCULATOR SIDEBAR ===== */
.time-calculator-wrapper {
    background:rgba(255,255,255,0.08);
    backdrop-filter:blur(10px);
    border-right:2px solid rgba(255,255,255,0.3);
    padding:15px;
    min-width:250px;
    max-width:700px;
    width:700px;
    overflow-y:auto;
    transition:width 0.1s;
}
.drag-bar {
    width:5px;
    cursor:col-resize;
    background:rgba(255,255,255,0.2);
}
.time-calculator-wrapper header {
    color:white; font-size:20px; font-weight:bold; text-align:center; margin-bottom:15px;
}
.time-calculator-wrapper .container {font-size:13px;}
.time-calculator-wrapper .offset-section {
    margin-bottom:15px;
    padding:10px;
    background:rgba(255,255,255,0.1);
    border:1px solid rgba(255,255,255,0.3);
    border-radius:6px; color:white;
}
.time-calculator-wrapper input[type="number"] {
    width:40px; padding:4px;
    text-align:center;
    border:1px solid rgba(255,255,255,0.4);
    border-radius:6px;
    background:rgba(255,255,255,0.15);
    color:white;
}
.time-calculator-wrapper table {width:100%;border-collapse:collapse;}
.time-calculator-wrapper th {
    background-color:#1e3c72; color:white; padding:6px; font-size:12px;
}
.time-calculator-wrapper td {
    padding:5px; text-align:center; font-size:12px; color:white;
}
.time-calculator-wrapper tr:nth-child(even) {background-color:rgba(255,255,255,0.05);}
.time-calculator-wrapper .result-box {
    background-color:rgba(255,255,255,0.1);
    border:1px solid rgba(255,255,255,0.3);
    border-radius:6px; padding:4px; min-height:18px; font-size:12px; color:white;
}
.time-calculator-wrapper .button {
    padding:5px 8px; border:none; border-radius:4px; font-size:11px; cursor:pointer;
}
.time-calculator-wrapper .add-button {background-color:#4CAF50;color:white;}
.time-calculator-wrapper .clear-button {background-color:#FF5722;color:white;}
.time-calculator-wrapper .clear-button:hover {opacity:0.8;}
.time-calculator-wrapper .button-container {margin-top:10px;display:flex;gap:5px;}
 
/* ===== ORIGINAL ALARM CLOCK CSS (UNMODIFIED) ===== */
.header{
    text-align:center; margin-bottom:30px; padding:20px; background:rgba(0,0,0,0.3);
    border-radius:10px; box-shadow:0 4px 15px rgba(0,0,0,0.2); position: relative;
}
.header-title{
    font-size:2.5em; font-weight:300; letter-spacing:2px; margin-bottom:10px;
    border:none; background:transparent; color:white; text-align:center; width:100%; cursor:text;
}
.header-title:focus{
    outline:none; background:rgba(255,255,255,0.1); border-radius:6px;
}
#undoButton {
    position: absolute; top: 20px; right: 20px; padding: 8px 14px; background: #FFC107; color: black;
    border: none; border-radius: 5px; cursor: pointer; display: none;
}
#undoButton:hover {background: #ffdb4d;}
.current-time{font-size:1.2em;opacity:0.9;}
.alarms-container{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(400px,1fr));
    gap:20px; max-width:1400px; margin:0 auto;
}
/* include full original alarm CSS here from your working HTML */
.alarm-card{
    background:rgba(255,255,255,0.1);
    border-radius:15px;
    padding:20px;
    backdrop-filter:blur(10px);
    border:1px solid rgba(255,255,255,0.2);
    box-shadow:0 8px 32px rgba(0,0,0,0.1);
    transition:all 0.3s ease;
    position: relative;
}
.alarm-card:hover{
    transform:translateY(-2px);
    box-shadow:0 12px 40px rgba(0,0,0,0.2);
}
.alarm-card.active{border-color:#4CAF50;background:rgba(76,175,80,0.1);}
.alarm-card.ringing{
    animation: ringPulse 1s infinite, flashAlarm 1s infinite;
    border-color: #FF5722;
    background: rgba(255, 87, 34, 0.2);
}
@keyframes ringPulse{
    0%,100%{transform:scale(1);}
    50%{transform:scale(1.02);}
}
@keyframes flashAlarm{
    0%{background-color:rgba(255,87,34,0.3);box-shadow:0 0 15px #FF5722;}
    50%{background-color:rgba(255,255,0,0.4);box-shadow:0 0 20px #FFD700;}
    100%{background-color:rgba(255,87,34,0.3);box-shadow:0 0 15px #FF5722;}
}
.alarm-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:15px;
    gap:10px;
}
.alarm-number{font-size:1.2em;font-weight:bold;color:#FFD700;}
.alarm-toggle{position:relative;width:60px;height:30px;}
.alarm-toggle input{opacity:0;width:0;height:0;}
.slider{
    position:absolute;
    cursor:pointer;
    top:0;left:0;right:0;bottom:0;
    background-color:#ccc;
    transition:0.4s;
    border-radius:30px;
}
.slider:before{
    position:absolute;
    content:"";
    height:22px;
    width:22px;
    left:4px;
    bottom:4px;
    background-color:white;
    transition:0.4s;
    border-radius:50%;
}
input:checked + .slider{background-color:#4CAF50;}
input:checked + .slider:before{transform:translateX(30px);}
.alarm-description{
    width:100%;
    padding:10px;
    margin-bottom:15px;
    border:1px solid rgba(255,255,255,0.3);
    border-radius:8px;
    background:rgba(255,255,255,0.1);
    color:white;
    font-size:14px;
}
.alarm-description::placeholder{color:rgba(255,255,255,0.6);}
.time-day-container{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:15px;
    margin-bottom:15px;
}
.time-input,.sound-select,.auto-snooze-select{
    padding:10px;
    border:1px solid rgba(255,255,255,0.3);
    border-radius:8px;
    background:rgba(255,255,255,0.1);
    color:black;
    font-size:14px;
}
.sound-container{display:flex;gap:10px;align-items:center;}
.sound-select{flex:1;}
.auto-snooze-block {margin-top:12px;}
.test-sound-btn,.snooze-btn{
    padding:8px 15px;
    border:none;
    border-radius:6px;
    background:rgba(255,255,255,0.2);
    color:white;
    cursor:pointer;
    transition:all 0.3s ease;
    font-size:12px;
}
.test-sound-btn:hover,.snooze-btn:hover{background:rgba(255,255,255,0.3);}
.test-sound-btn.playing{
    background:#4CAF50 !important;
    box-shadow:0 0 10px #4CAF50;
}
.snooze-btn{
    background:#FF5722;
    width:100%;
    padding:12px;
    font-size:14px;
    font-weight:bold;
    display:none;
}
.snooze-btn.visible{display:block;}
.status{font-size:12px;opacity:0.8;text-align:center;margin-top:10px;}
.days-grid{
    display:grid;
    grid-template-columns:repeat(7,1fr);
    gap:5px;
    margin-bottom:15px;
}
.day-checkbox{display:none;}
.day-label{
    padding:8px 4px;
    text-align:center;
    border:1px solid rgba(255,255,255,0.3);
    border-radius:6px;
    cursor:pointer;
    font-size:12px;
    transition:all 0.3s ease;
}
.day-checkbox:checked + .day-label{
    background:#4CAF50;
    border-color:#4CAF50;
}
.add-alarm-card {
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:3em;
    background:rgba(255,255,255,0.1);
    border-radius:15px;
    border:2px dashed rgba(255,255,255,0.4);
    cursor:pointer;
    transition:all 0.3s ease;
}
.add-alarm-card:hover { background:rgba(255,255,255,0.2); }
.remove-alarm-btn {
    background:red;
    color:white;
    border:none;
    border-radius:50%;
    width:24px;
    height:24px;
    cursor:pointer;
    font-weight:bold;
    line-height:1;
    position:absolute;
    bottom:10px;
    right:10px;
}
.remove-alarm-btn:hover { background:darkred; }
.custom-audio-input { font-size:12px; color:white; }
</style>
</head>
<body>
 
<div id="layout">
    <!-- Calculator -->
    <div class="time-calculator-wrapper" id="calcWrapper">
        <header>Time Calculator</header>
        <div class="container">
            <div class="offset-section">
                <label>Offset Time:</label>
                <input type="number" id="offsetHours" min="0" max="99">hr
                <input type="number" id="offsetMinutes" min="0" max="59">min
                <input type="number" id="offsetSeconds" min="0" max="59">sec
                <button id="clearOffset" class="button clear-button">Clear</button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>H:M:S</th>
                        <th>Result</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="timeRows"></tbody>
            </table>
            <div class="button-container">
                <button id="addRow" class="button add-button">Add Row</button>
                <button id="clearAllRows" class="button clear-button">Clear Rows</button>
		<button id="printCalc" class="button">Print</button>
            </div>
        </div>
    </div>
 
    <!-- Drag bar -->
    <div class="drag-bar" id="dragBar"></div>
 
    <!-- Alarm Clock -->
    <div id="alarmContent" style="flex:1; padding:20px;">
        <div class="header">
            <input type="text" id="pageTitle" class="header-title">
            <button id="undoButton" onclick="alarmSystem.undoLastRemoval()">Undo</button>
            <div class="current-time" id="currentTime"></div>
        </div>
        <div class="alarms-container" id="alarmsContainer"></div>
    </div>
</div>
<script>
/* ===== TIME CALCULATOR SCRIPT ===== */
let rowCount=0,maxRows=100;
function createTimeInput(cn,max){
    const i=document.createElement('input');
    i.type='number';i.min=0;i.max=max;i.classList.add(cn);
    i.addEventListener('focus',()=>i.select());
    i.addEventListener('input',function(){
        if(this.value.length>2)this.value=this.value.slice(0,2);
        if(parseInt(this.value)>max)this.value=max;
    });
    return i;
}
function setAutoTab(c,n){c.addEventListener('input',function(){if(this.value.length===2){n.focus();n.select();}});}
function createTimeRow(){
    if(rowCount>=maxRows)return;rowCount++;
    const tb=document.getElementById('timeRows'),tr=document.createElement('tr');
    const num=document.createElement('td');num.textContent=rowCount;tr.appendChild(num);
    const cell=document.createElement('td');
    const h=createTimeInput('hourInput',99),m=createTimeInput('minuteInput',59),s=createTimeInput('secondInput',59);
    cell.append(h, document.createTextNode('hr '), m, document.createTextNode('min '), s, document.createTextNode('sec'));
    setAutoTab(h,m);setAutoTab(m,s);
    const rcell=document.createElement('td'),rb=document.createElement('div');rb.classList.add('result-box');rcell.appendChild(rb);
    const acell=document.createElement('td'),clr=document.createElement('button');clr.textContent="Clear";clr.classList.add('button','clear-button');
    clr.addEventListener('click',()=>{h.value="";m.value="";s.value="";rb.textContent="";h.focus();h.select();});
    acell.appendChild(clr);
    tr.append(cell,rcell,acell);tb.appendChild(tr);
    s.addEventListener('input',function(){
        if(this.value.length===2){const nx=tb.children[Array.from(tb.children).indexOf(tr)+1];if(nx)nx.querySelector('.hourInput').focus();}
    });
    updateResults();
}
function updateResults(){
    const oh=parseInt(document.getElementById('offsetHours').value)||0,
          om=parseInt(document.getElementById('offsetMinutes').value)||0,
          os=parseInt(document.getElementById('offsetSeconds').value)||0;
    document.querySelectorAll('#timeRows tr').forEach(tr=>{
        const h=parseInt(tr.querySelector('.hourInput').value)||0,
              m=parseInt(tr.querySelector('.minuteInput').value)||0,
              s=parseInt(tr.querySelector('.secondInput').value)||0;
        if(h||m||s){
            let ts=(h+oh)*3600+(m+om)*60+(s+os),
                fh=Math.floor(ts/3600),
                rm=ts%3600,
                fm=Math.floor(rm/60),
                fs=rm%60;
            tr.querySelector('.result-box').textContent=`${String(fh).padStart(2,'0')}:${String(fm).padStart(2,'0')}:${String(fs).padStart(2,'0')}`;
        } else tr.querySelector('.result-box').textContent="";
    });
}
document.getElementById('addRow').onclick=()=>{createTimeRow();if(rowCount>=maxRows)document.getElementById('addRow').disabled=true;};
document.getElementById('clearAllRows').onclick=()=>{document.querySelectorAll('#timeRows tr').forEach(tr=>{tr.querySelectorAll('input').forEach(i=>i.value="");tr.querySelector('.result-box').textContent="";});};
document.getElementById('clearOffset').onclick=()=>{document.getElementById('offsetHours').value="";document.getElementById('offsetMinutes').value="";document.getElementById('offsetSeconds').value="";updateResults();};
document.addEventListener('input',updateResults);
for(let i=0;i<10;i++)createTimeRow();

// ===== Auto Tab for Offset inputs =====
const offsetHours = document.getElementById('offsetHours');
const offsetMinutes = document.getElementById('offsetMinutes');
const offsetSeconds = document.getElementById('offsetSeconds');
 
setAutoTab(offsetHours, offsetMinutes);
setAutoTab(offsetMinutes, offsetSeconds);

// After offsetSeconds is filled, go to first row's hour input
offsetSeconds.addEventListener('input', function() {
    if (this.value.length === 2) {
        const firstHourInput = document.querySelector('#timeRows tr:first-child .hourInput');
        if (firstHourInput) {
            firstHourInput.focus();
            firstHourInput.select();
        }
    }
});
// ===== PRINT CALCULATOR with values, darker/larger font for paper =====
document.getElementById('printCalc').addEventListener('click', function() {
    const calcClone = document.getElementById('calcWrapper').cloneNode(true);
 
    // Preserve input values in the clone
    calcClone.querySelectorAll('input').forEach(input => {
        input.setAttribute('value', input.value);
    });
 
    const printWindow = window.open('', '', 'width=800,height=600');
    printWindow.document.write('<html><head><title>Time Calculator</title>');
 
    const styles = Array.from(document.styleSheets).map(styleSheet => {
        try {
            return Array.from(styleSheet.cssRules).map(rule => rule.cssText).join('\n');
        } catch(e) {
            return '';
        }
    }).join('\n');
 
    printWindow.document.write('<style>' +
        styles +
        `
        /* === PRINT OVERRIDES FOR READABILITY === */
        body {
            background: white !important;
            color: black !important;
            font-size: 10pt !important;
            font-family: Arial, sans-serif !important;
        }
        table, th, td {
            color: black !important;
            border-color: black !important;
            border-width: 2px !important;
        }
        input {
            color: black !important;
            font-size: 10pt !important;
            border: 1px solid black !important;
            background: white !important;
        }
        .result-box {
            color: black !important;
            font-size: 10pt !important;
            border-color: black !important;
            background: white !important;
        }
        th {
            background: #ddd !important;
            font-weight: bold !important;
        }
        `
    + '</style>');
 
    printWindow.document.write('</head><body>');
    printWindow.document.write(calcClone.outerHTML);
    printWindow.document.write('</body></html>');
    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
    printWindow.close();
});/* ===== DRAG RESIZE ===== */
const dragBar=document.getElementById('dragBar'),calcWrapper=document.getElementById('calcWrapper');
dragBar.addEventListener('mousedown',e=>{
    e.preventDefault();
    document.addEventListener('mousemove',resize);
    document.addEventListener('mouseup',stopResize);
});
function resize(e){
    const w=e.clientX;
    if(w>=250 && w<=600) calcWrapper.style.width=w+'px';
}
function stopResize(){document.removeEventListener('mousemove',resize);}
 
/* ===== FULL ORIGINAL MULTI ALARM CLOCK JS BELOW ===== */
 
/* Your full original Alarm Clock JS from the working HTML you pasted earlier goes here â€“ EXACTLY as it was */
// ===== IndexedDB Helper for Custom Audio Storage =====
class AudioDB {
    constructor() {
        this.dbName = 'AlarmCustomSounds';
        this.storeName = 'sounds';
        this.db = null;
    }
    async init() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(this.dbName, 1);
            request.onupgradeneeded = (e) => {
                e.target.result.createObjectStore(this.storeName);
            };
            request.onsuccess = (e) => {
                this.db = e.target.result;
                resolve();
            };
            request.onerror = (e) => reject(e);
        });
    }
    async saveSound(id, blob) {
        return new Promise((resolve, reject) => {
            const tx = this.db.transaction(this.storeName, 'readwrite');
            tx.objectStore(this.storeName).put(blob, id);
            tx.oncomplete = resolve;
            tx.onerror = reject;
        });
    }
    async getSound(id) {
        return new Promise((resolve, reject) => {
            const tx = this.db.transaction(this.storeName, 'readonly');
            const req = tx.objectStore(this.storeName).get(id);
            req.onsuccess = () => resolve(req.result || null);
            req.onerror = reject;
        });
    }
}
const audioDB = new AudioDB();
 
// ===== Alarm System =====
class MasterControlAlarms {
    constructor() {
        this.alarms = [];
        this.lastRemovedAlarm = null;
        this.audioContext = null;
        this.sounds = {
            'Beep': this.generateBeepSound,
            'Chime': this.generateChimeSound,
            'Alert': this.generateAlertSound,
            'Buzz': this.generateBuzzSound,
            'Ding': this.generateDingSound,
            'Horn': this.generateHornSound,
            'Tone': this.generateToneSound,
            'Custom': this.playCustomSound
        };
        this.activeAlarms = new Set();
        this.soundLoops = {};
        this.init();
    }
 
    async init() {
        await audioDB.init();
        this.initAudioContext();
        await this.loadAlarms();
        this.loadTitle();
        await this.loadCustomSoundsFromDB();
        this.createAlarmCards();
        this.startClock();
        this.startAlarmChecker();
        document.getElementById('pageTitle').addEventListener('input', (e) => {
            localStorage.setItem('pageTitle', e.target.value);
        });
        this.setupUndoShortcut();
    }
 
    initAudioContext() {
        try { this.audioContext = new (window.AudioContext || window.webkitAudioContext)(); }
        catch (e) { console.warn('Audio context not supported'); }
    }
 
    loadTitle() {
        const saved = localStorage.getItem('pageTitle') || 'MULTI ALARM CLOCK SYSTEM';
        document.getElementById('pageTitle').value = saved;
    }
 
    async loadAlarms() {
        const savedAlarms = localStorage.getItem('masterControlAlarms');
        if (savedAlarms) { this.alarms = JSON.parse(savedAlarms); }
        else {
            for (let i = 0; i < 20; i++) {
                this.alarms.push({
                    id: i, enabled: false, time: '09:00',
                    days: [false,false,false,false,false,false,false],
                    description: `Alarm ${i+1}`, sound: 'Beep',
                    isRinging: false, lastTriggered: null,
                    autoSnoozeTime: 10, customSoundUrl: null
                });
            }
        }
    }
async loadCustomSoundsFromDB() {
        for (let alarm of this.alarms) {
            if (alarm.sound === 'Custom') {
                const blob = await audioDB.getSound(alarm.id);
                if (blob) alarm.customSoundUrl = URL.createObjectURL(blob);
            }
        }
    }
 
    saveAlarms() {
        localStorage.setItem('masterControlAlarms', JSON.stringify(this.alarms));
    }
 
    createAlarmCards() {
        const container = document.getElementById('alarmsContainer');
        container.innerHTML = '';
        this.alarms.forEach((alarm,index) => {
            const card = document.createElement('div');
            card.className = `alarm-card ${alarm.enabled?'active':''}`;
            card.id = `alarm-${index}`;
            card.innerHTML = `
                <div class="alarm-header">
                    <div class="alarm-number">ALARM ${index+1}</div>
                    <label class="alarm-toggle">
                        <input type="checkbox" ${alarm.enabled?'checked':''} onchange="alarmSystem.toggleAlarm(${index})">
                        <span class="slider"></span>
                    </label>
                </div>
                <input type="text" class="alarm-description" value="${alarm.description}" onchange="alarmSystem.updateDescription(${index}, this.value)">
                <div class="time-day-container">
                    <input type="time" class="time-input" value="${alarm.time}" onchange="alarmSystem.updateTime(${index}, this.value)">
                    <div class="days-grid">
                        ${['S','M','T','W','T','F','S'].map((d,dayIndex)=>`
                            <input type="checkbox" class="day-checkbox" id="day-${index}-${dayIndex}" ${alarm.days[dayIndex]?'checked':''} onchange="alarmSystem.updateDay(${index}, ${dayIndex}, this.checked)">
                            <label class="day-label" for="day-${index}-${dayIndex}">${d}</label>`).join('')}
                    </div>
                </div>
                <div class="sound-container">
                    <select class="sound-select" onchange="alarmSystem.updateSound(${index}, this.value)">
                        ${Object.keys(this.sounds).map(s=>`<option value="${s}" ${alarm.sound===s?'selected':''}>${s}</option>`).join('')}
                    </select>
                    <button class="test-sound-btn" onclick="alarmSystem.testSoundForAlarm(${index}, this)">Test</button>
                </div>
                ${alarm.sound==='Custom' ? `<input type="file" class="custom-audio-input" accept="audio/*" onchange="alarmSystem.updateCustomSound(${index}, this.files[0])">` : ''}
                <div class="auto-snooze-block">
                    <label>Auto-Snooze:
                        <select class="auto-snooze-select" onchange="alarmSystem.updateAutoSnooze(${index}, this.value)">
                            <option value="10" ${alarm.autoSnoozeTime===10?'selected':''}>10 seconds</option>
                            <option value="15" ${alarm.autoSnoozeTime===15?'selected':''}>15 seconds</option>
                            <option value="20" ${alarm.autoSnoozeTime===20?'selected':''}>20 seconds</option>
                            <option value="30" ${alarm.autoSnoozeTime===30?'selected':''}>30 seconds</option>
                            <option value="45" ${alarm.autoSnoozeTime===45?'selected':''}>45 seconds</option>
                            <option value="60" ${alarm.autoSnoozeTime===60?'selected':''}>1 minute</option>
                            <option value="none" ${alarm.autoSnoozeTime===null?'selected':''}>No auto-snooze</option>
                        </select>
                    </label>
                </div>
                <button class="snooze-btn" id="snooze-${index}" onclick="alarmSystem.snoozeAlarm(${index})">SNOOZE</button>
                <div class="status" id="status-${index}">${alarm.enabled?'ARMED':'DISABLED'}</div>
                <button class="remove-alarm-btn" onclick="alarmSystem.confirmRemoveAlarm(${index})">-</button>
            `;
            container.appendChild(card);
        });
        if (this.alarms.length < 100) {
            const addTile = document.createElement('div');
            addTile.className = 'add-alarm-card';
            addTile.textContent = '+';
            addTile.title = 'Add New Alarm';
            addTile.onclick = () => this.addAlarm();
            container.appendChild(addTile);
        }
    }
 
    addAlarm() {
        if (this.alarms.length >= 100) return alert('Maximum of 100 alarms reached.');
        const newId = this.alarms.length;
        this.alarms.push({
            id:newId, enabled:false, time:'09:00',
            days:[false,false,false,false,false,false,false],
            description:`Alarm ${newId+1}`, sound:'Beep',
            isRinging:false, lastTriggered:null,
            autoSnoozeTime:10, customSoundUrl:null
        });
        this.saveAlarms();
        this.createAlarmCards();
    }
confirmRemoveAlarm(index) {
        if (confirm("Are you sure you want to remove this alarm?")) {
            this.removeAlarm(index);
        }
    }
 
    removeAlarm(index) {
        this.lastRemovedAlarm = { alarm: this.alarms[index], index: index };
        this.alarms.splice(index,1);
        this.saveAlarms();
        this.createAlarmCards();
        document.getElementById("undoButton").style.display = 'inline-block';
    }
 
    undoLastRemoval() {
        if (!this.lastRemovedAlarm) return;
        this.alarms.splice(this.lastRemovedAlarm.index, 0, this.lastRemovedAlarm.alarm);
        this.saveAlarms();
        this.createAlarmCards();
        this.lastRemovedAlarm = null;
        document.getElementById("undoButton").style.display = 'none';
    }
 
    setupUndoShortcut() {
        document.addEventListener('keydown', (e) => {
            const activeEl = document.activeElement;
            if (e.ctrlKey && e.key.toLowerCase() === 'z' && activeEl.tagName !== 'INPUT' && activeEl.tagName !== 'TEXTAREA') {
                e.preventDefault();
                this.undoLastRemoval();
            }
        });
    }
 
    startClock() {
        const updateTime = () => {
            const now = new Date();
            document.getElementById('currentTime').textContent =
                now.toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'}) +
                " - " + now.toLocaleTimeString('en-US',{hour12:false});
        };
        updateTime();
        setInterval(updateTime, 1000);
    }
 
    startAlarmChecker() { setInterval(() => { this.checkAlarms(); }, 1000); }
 
    checkAlarms() {
        const now = new Date();
        const currentDay = now.getDay();
        const currentTime = now.toTimeString().substr(0,5);
        this.alarms.forEach((alarm,index) => {
            if (!alarm.enabled || alarm.isRinging) return;
            if (alarm.lastTriggered) {
                const diff = (now - new Date(alarm.lastTriggered))/1000;
                if (diff < 60) return;
            }
            if (alarm.days[currentDay] && alarm.time === currentTime) {
                this.triggerAlarm(index);
            }
        });
    }
 
    triggerAlarm(index) {
        const alarm = this.alarms[index];
        alarm.isRinging = true;
        alarm.lastTriggered = new Date();
        this.activeAlarms.add(index);
        document.getElementById(`alarm-${index}`).classList.add('ringing');
        document.getElementById(`snooze-${index}`).classList.add('visible');
        if (alarm.sound === 'Custom' && alarm.customSoundUrl) {
            this.playCustomSound(alarm.customSoundUrl);
            this.soundLoops[index] = setInterval(() => this.playCustomSound(alarm.customSoundUrl), 2000);
        } else {
            this.playSelectedSound(alarm.sound);
            this.soundLoops[index] = setInterval(() => this.playSelectedSound(alarm.sound), 2000);
        }
        if (alarm.autoSnoozeTime) {
            setTimeout(() => { if (alarm.isRinging) this.snoozeAlarm(index); }, alarm.autoSnoozeTime * 1000);
        }
        this.saveAlarms();
    }
 
    snoozeAlarm(index) {
        const alarm = this.alarms[index];
        alarm.isRinging = false;
        document.getElementById(`alarm-${index}`).classList.remove('ringing');
        document.getElementById(`snooze-${index}`).classList.remove('visible');
        this.activeAlarms.delete(index);
        if (this.soundLoops[index]) {
            clearInterval(this.soundLoops[index]);
            delete this.soundLoops[index];
        }
        this.saveAlarms();
    }
 
    toggleAlarm(index) {
        this.alarms[index].enabled = !this.alarms[index].enabled;
        const card = document.getElementById(`alarm-${index}`);
        const status = document.getElementById(`status-${index}`);
        if (this.alarms[index].enabled) {
            card.classList.add('active'); status.textContent = 'ARMED';
        } else {
            card.classList.remove('active'); status.textContent = 'DISABLED';
            if (this.alarms[index].isRinging) this.snoozeAlarm(index);
            if (this.soundLoops[index]) {
                clearInterval(this.soundLoops[index]);
                delete this.soundLoops[index];
            }
        }
        this.saveAlarms();
    }
 updateDescription(i,v){ this.alarms[i].description = v; this.saveAlarms(); }
    updateTime(i,v){ this.alarms[i].time = v; this.saveAlarms(); }
    updateDay(i,d,c){ this.alarms[i].days[d] = c; this.saveAlarms(); }
    updateAutoSnooze(i,val){ this.alarms[i].autoSnoozeTime = (val==='none')?null:parseInt(val,10); this.saveAlarms(); }
    updateSound(i,v){ this.alarms[i].sound = v; if (v!=='Custom') this.alarms[i].customSoundUrl = null; this.saveAlarms(); this.createAlarmCards(); }
 
    async updateCustomSound(i,file){
        if(file){
            this.alarms[i].customSoundUrl = URL.createObjectURL(file);
            await audioDB.saveSound(this.alarms[i].id, file);
            this.saveAlarms();
        }
    }
 
    playSelectedSound(type){ if (this.sounds[type]) this.sounds[type].call(this); }
    playCustomSound(url){ if (url){ const audio=new Audio(url); audio.play(); } }
 
    // Generated sounds
    generateBeepSound(){ for(let i=0;i<5;i++){ this.playTone(800,'sine',0.15,this.audioContext.currentTime+i*0.25); } }
    generateChimeSound(){ let t=this.audioContext.currentTime; this.playTone(523,'triangle',0.3,t); this.playTone(659,'triangle',0.3,t+0.4); this.playTone(784,'triangle',0.3,t+0.8); }
    generateAlertSound(){ let t=this.audioContext.currentTime; for(let i=0;i<3;i++){ this.playTone(1000,'square',0.2,t+i*0.3); this.playTone(600,'square',0.2,t+0.15+i*0.3); } }
    generateBuzzSound(){ let t=this.audioContext.currentTime; const o=this.audioContext.createOscillator(),g=this.audioContext.createGain();o.type='sawtooth';o.frequency.setValueAtTime(200,t);g.gain.setValueAtTime(0.25,t);o.connect(g);g.connect(this.audioContext.destination);o.start(t);o.stop(t+1.2); }
    generateDingSound(){ let t=this.audioContext.currentTime; this.playTone(880,'sine',0.6,t); this.playTone(1760,'sine',0.5,t+0.35); }
    generateHornSound(){ let t=this.audioContext.currentTime; const o=this.audioContext.createOscillator(),g=this.audioContext.createGain();o.type='square';o.frequency.setValueAtTime(440,t);g.gain.setValueAtTime(0.1,t);g.gain.linearRampToValueAtTime(0.5,t+0.25);g.gain.linearRampToValueAtTime(0.1,t+0.8);o.connect(g);g.connect(this.audioContext.destination);o.start(t);o.stop(t+1.0); }
    generateToneSound(){ for(let i=0;i<4;i++){ this.playTone(880,'sine',0.3,this.audioContext.currentTime+i*0.35); } }
 
    playTone(freq,type,duration,startTime=this.audioContext.currentTime){
        if(!this.audioContext) return;
        const o=this.audioContext.createOscillator(),g=this.audioContext.createGain();
        o.connect(g);g.connect(this.audioContext.destination);
        o.type=type;o.frequency.setValueAtTime(freq,startTime);
        g.gain.setValueAtTime(0.3,startTime);
        g.gain.exponentialRampToValueAtTime(0.01,startTime+duration);
        o.start(startTime);o.stop(startTime+duration);
    }
 
    testSoundForAlarm(i,btn){
        const alarm = this.alarms[i];
        if(alarm.sound==='Custom' && alarm.customSoundUrl){
            this.playCustomSound(alarm.customSoundUrl);
        } else {
            this.playSelectedSound(alarm.sound);
        }
        btn.classList.add('playing');
        setTimeout(()=>btn.classList.remove('playing'),300);
    }
}
// ===== Bootstrapping =====
let alarmSystem;
document.addEventListener('DOMContentLoaded',()=>{ 
    alarmSystem = new MasterControlAlarms(); 
});
document.addEventListener('click',()=>{ 
    if(alarmSystem?.audioContext?.state==='suspended') {
        alarmSystem.audioContext.resume(); 
    }
});
</script>
</body>

</html>
